name: MLflow CI

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ Set up job
    - name: Set up job
      run: echo "Starting MLflow CI job"

    # 2Ô∏è‚É£ Run actions/checkout@v3
    - name: Checkout repository
      uses: actions/checkout@v3

    # 3Ô∏è‚É£ Set up Python 3.12.7
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12.7'

    # 4Ô∏è‚É£ Check Env
    - name: Check Python Env
      run: |
        python --version
        pip --version

    # 5Ô∏è‚É£ Install dependencies
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mlflow==2.7.1 scikit-learn pandas numpy gdown  # gdown untuk Google Drive

    # 6Ô∏è‚É£ Run MLflow Project
    - name: Run MLflow Project
      run: mlflow run MLProject --experiment-name "Workflow-CI" -P alpha=0.5 -P l1_ratio=0.1 --no-conda

    # 7Ô∏è‚É£ Get latest MLflow run_id
    - name: Get latest MLflow run_id
      id: get_run
      run: |
        RUN_ID=$(ls -td MLProject/mlruns/0/* | head -n1 | xargs -n1 basename)
        echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

    # 8Ô∏è‚É£ Install Python dependencies (optional, jika artefak Python diperlukan)
    - name: Install extra dependencies
      run: pip install -r requirements.txt || echo "No extra dependencies"

    # 9Ô∏è‚É£ Upload to Google Drive
    - name: Upload to Google Drive
      run: |
        # Contoh upload pakai gdown/gdrive CLI atau script Python
        # gdrive upload MLProject/mlruns/$RUN_ID
        echo "Upload placeholder - ganti sesuai metode upload"

    # üîü Build Docker Model
    - name: Build Docker Image
      run: |
        RUN_ID=${{ steps.get_run.outputs.run_id }}
        mlflow models build-docker -m MLProject/mlruns/0/$RUN_ID/artifacts/model -n workflow-ci-image

    # 1Ô∏è‚É£1Ô∏è‚É£ Log in to Docker Hub
    - name: Docker Login
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    # 1Ô∏è‚É£2Ô∏è‚É£ Tag Docker Image
    - name: Tag Docker Image
      run: |
        docker tag workflow-ci-image ${{ secrets.DOCKER_USERNAME }}/workflow-ci:latest

    # 1Ô∏è‚É£3Ô∏è‚É£ Push Docker Image
    - name: Push Docker Image
      run: |
        docker push ${{ secrets.DOCKER_USERNAME }}/workflow-ci:latest

    # 1Ô∏è‚É£4Ô∏è‚É£ Post Log in to Docker Hub
    - name: Post Docker Login
      run: echo "Docker login completed"

    # 1Ô∏è‚É£5Ô∏è‚É£ Post Set up Python 3.12.7
    - nam
